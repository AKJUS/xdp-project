#+Title: Using veth benchmark (03)

Finding =veth= driver kernel bottlenecks using
Maryam's [[https://github.com/maryamtahhan/veth-benchmark/][veth-benchmark]].

That benchmark exercise =AF_XDP= in containers (thus veth) using [[https://cndp.io/][CNDP]] to have a
practical use-case, to assess the overhead this consumer also brings to the
equation.

* Table of Contents                                                     :toc:
- [[#github][GitHub]]
  - [[#setup][Setup]]
  - [[#compile][Compile]]
- [[#setting-up-the-containers][Setting up the containers]]
- [[#setting-xdp-progs-on-the-host-side-veths][Setting xdp progs on the host side veths]]
- [[#run-the-applications-in-the-containers][Run the applications in the containers]]
  - [[#cndp-1-txgen][cndp-1: TXGen]]
  - [[#cndp-2-cnet-graph][cndp-2: cnet-graph]]

* GitHub

https://github.com/maryamtahhan/veth-benchmark/

Forked:
https://github.com/netoptimizer/veth-benchmark

** Setup

As instructed in README.md, run =./configure=

** Compile

(Worked)

* Setting up the containers

Setup the containers by running the ./container_setup.sh script.

#+begin_src sh
./container_setup.sh
#+end_src

The MAC-addresses for the =vethN= net devices are needed later, and are stored
on the config file: =veth_mac_addrs.conf=.

Two containers got created: cndp-1 and cndp-2

#+begin_example
$ docker ps
CONTAINER ID   IMAGE             COMMAND       CREATED         STATUS         PORTS     NAMES
2ced507df83c   cndp-veth-bench   "/bin/bash"   2 minutes ago   Up 2 minutes             cndp-2
3440165755c2   cndp-veth-bench   "/bin/bash"   2 minutes ago   Up 2 minutes             cndp-1
#+end_example

* Setting xdp progs on the host side veths

(Still following [[https://github.com/maryamtahhan/veth-benchmark#readme][README]] from veth-benchmark)

The =veth_setup.sh= script will load XDP redirect programs on the veth devices
on the "host" (meaning outside the containers), using xdp-tools program
=xdp-loader= (notice this dependency).

Creating this XDP redirect setup (also pictured in [[https://github.com/maryamtahhan/veth-benchmark#readme][README]]):
#+begin_example
#    +-------------------+                         +------------------+
#    |      cndp-1       |                         |      cndp-2      |
#    | +--------------+  |                         | +--------------+ |
#    | |              |  |                         | |              | |
#    | |    TXGEN     |  |                         | |    CNET      | |
#    | |              |  |                         | |              | |
#    | +=====+--+=====+  |                         | +=====+--+=====+ |
#    | |veth2|  |veth4|  |                         | |veth6|  |veth8| |
#    | +==|==+  +==|==+  |                         | +==|==+  +==|==+ |
#    +----|--------|-----+                         +----|--------|----+
#      +==|==+  +==|==+                              +==|==+  +==|==+
#      |veth1|  |veth3|                              |veth5|  |veth7|
#      +==|==+  +==^==+                              +==|==+  +==^==+
#         |        |______redirect veth 5 to veth3______|        |
#         |______________redirect veth 1 to veth7________________|
#+end_example

Program list with bpftool:
#+begin_example
# bpftool net
xdp:
veth1(17) driver id 111
veth3(19) driver id 168
veth5(22) driver id 149
veth7(24) driver id 130
[...]
#+end_example

Program list with xdp-loader:
#+begin_example
$ sudo xdp-loader status
CURRENT XDP PROGRAM STATUS:

Interface        Prio  Program name      Mode     ID   Tag               Chain actions
--------------------------------------------------------------------------------------
lo                     <No XDP program loaded!>
[...]
veth1                  xdp_dispatcher    native   111  90f686eb86991928 
 =>              50     xdp_prog_redirect          120  9da7c6f214b4de60  XDP_PASS
veth3                  xdp_dispatcher    native   168  90f686eb86991928 
 =>              50     xdp_pass_func             177  3b185187f1855c4c  XDP_PASS
br0                    <No XDP program loaded!>
veth5                  xdp_dispatcher    native   149  90f686eb86991928 
 =>              50     xdp_prog_redirect          158  9da7c6f214b4de60  XDP_PASS
veth7                  xdp_dispatcher    native   130  90f686eb86991928 
 =>              50     xdp_pass_func             139  3b185187f1855c4c  XDP_PASS
#+end_example

* Run the applications in the containers

Two containers: cndp-1 and cndp-2
 - *cndp-1* - runs: *TXGen*
   - Function: an /af_xdp based traffic generator/
 - *cndp-2* - runs: *cnet-graph*
   - Function: lightweight /AF_XDP based networking stack/.

** cndp-1: TXGen

Starting Traffic generator in cndp-1:

#+begin_src sh
# docker exec -ti cndp-1 /cndp/builddir/usrtools/txgen/app/txgen \
    -c /cndp/builddir/usrtools/txgen/app/txgen.jsonc
#+end_src

For perf profiling needs:
 - txgen is configured to use CPU cores 2 and 4.

We need to configure the traffic generator via the command line interface that
shows the prompt =TXGen:/>= :

#+begin_src sh
# dst mac veth8
set 0 dst mac 1a:bf:be:c1:a9:ea
set 0 dst ip 192.168.100.20
set 0 src ip 192.168.200.10/32
set 0 size 512
enable 0 chksum

# dst mac veth4
set 1 dst mac 1e:e4:9e:d4:07:6f
set 1 dst ip 192.168.200.11
set 1 src ip 192.168.100.21/32
enable 1 chksum
#+end_src

To start traffic use:
#+begin_src sh
TXGen:/> start 0
#+end_src

To stop traffic use:
#+begin_src sh
TXGen:/> stp
#+end_src

** cndp-2: cnet-graph

Start container (cndp-2) that runs a
  - lightweight /AF_XDP based networking stack/.

#+begin_src sh
docker exec -ti cndp-2 ./run_cnet.sh
#+end_src

I needed to change the CPUs used by *cnet-graph* in file =cnetfwd-graph.jsonc=.
 - https://github.com/maryamtahhan/veth-benchmark/blob/main/containerization/cnetfwd-graph.jsonc#L112

I changed it to run on CPU core 5 and timer on core 1.
#+begin_src json
    "lcore-groups": {
        "initial": [0],
        "timer": [1],
        "group0": [5],
        "default": ["0"]
    },
#+end_src

