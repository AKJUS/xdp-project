# -*- fill-column: 79; -*-
#+TITLE: Adding packet queueing to XDP
#+AUTHOR: Toke Høiland-Jørgensen <toke@redhat.com>
#+EMAIL: toke@redhat.com
#+REVEAL_THEME: redhat
#+REVEAL_TRANS: linear
#+REVEAL_MARGIN: 0
#+REVEAL_EXTRA_JS: { src: '../reveal.js/js/redhat.js'}
#+REVEAL_ROOT: ../reveal.js
#+OPTIONS: reveal_center:nil reveal_control:t reveal_history:nil
#+OPTIONS: reveal_width:1600 reveal_height:900
#+OPTIONS: ^:nil tags:nil toc:nil num:nil ':t

* For conference: Linux Plumbers Conference 2022

This presentation will be given at [[https://lpc.events/][LPC 2022] the
Linux Plumbers Conference.

* Slides below                                                     :noexport:

Only sections with tag ":export:" will end-up in the presentation.

Colors are choosen via org-mode italic/bold high-lighting:
 - /italic/ = /green/
 - *bold*   = *yellow*
 - */italic-bold/* = red

* Slide:                                                             :export:
:PROPERTIES:
:reveal_extra_attr: class="img-slide"
:END:

#+ATTR_html: :height 720 :style position:relative;top:-2em;
[[file:talk-about-queueing.jpg]]

* Review: How does XDP_REDIRECT work?                              :noexport:

1. /Program/ calls =bpf_redirect_map()=, returning =XDP_REDIRECT=
  - Helper sets per-cpu fields in =struct bpf_redirect_info=
2. *Driver* calls =xdp_do_redirect()=
  - Converts =xdp_buff= to =xdp_frame=, calls /*map type enqueue function*/
  - Buffers frame in destination map (up to =XDP_BULK_QUEUE_SIZE= (16) pkts)
3. *Driver* calls =xdp_do_flush()= at end of NAPI
  - Flushes buffered packets

Adding new redirect types requires /*no driver changes*/.

* Review: How does XDP_REDIRECT work?                                :export:
:PROPERTIES:
:reveal_extra_attr: class="img-slide"
:END:

#+ATTR_HTML: :class figure figure-bg
[[file:xdp-redirect-flow.svg]]

* Why does XDP need queueing?                                        :export:
:PROPERTIES:
:reveal_extra_attr: class="img-slide"
:END:

#+ATTR_html: :height 580
#+CAPTION: 100->10 Gbps rate transition, 10ms base RTT
[[file:tcp_1up_-_Linux_vs_XDP_forwarding.png]]


* The ingredients of queueing                                        :export:
:PROPERTIES:
:reveal_extra_attr: class="mid-slide"
:END:
- Somewhere to store packets
- A way to pull the packets back out

* A way to store packets: A new BPF map                              :export:
#+begin_quote
"Bad programmers worry about the code. Good programmers worry about data
structures and their relationships."

Linus Torvalds in https://lwn.net/Articles/193245/
#+end_quote

* Detour: EDT packet scheduling
Turns out we can represent lots of packet scheduling algorithms using
time-based scheduling (sch_fq, etc)

So we need a priority queue

* Slide: Performance overhead of map types                           :export:
:PROPERTIES:
:reveal_extra_attr: class="img-slide"
:END:

#+ATTR_html: :height 720
[[file:pifo-performance.svg]]

* Slide: Performance overhead of bpf_timer                           :export:
:PROPERTIES:
:reveal_extra_attr: class="img-slide"
:END:

#+ATTR_html: :height 720
[[file:pifo-performance-timer.svg]]
* A way to get the packets out: TX scheduling

Idea: re-use ndo_xdp_xmit()

* Review: Netstack forwarding flow (simplified)                      :export:
:PROPERTIES:
:reveal_extra_attr: class="img-slide"
:END:

#+ATTR_HTML: :class figure figure-bg
[[file:netstack-forwarding-flow.svg]]

* Attempt 1: TX hook

* Attempt 2: Send helper

* Fixing performance?
- New callback scheduling?

* Unsolved problem: Pushback from driver
- How to get this

* Slide: End: /Questions?/                                         :export:
:PROPERTIES:
:reveal_extra_attr: class="mid-slide"
:END:

[[https://git.kernel.org/pub/scm/linux/kernel/git/toke/linux.git/log/?h=xdp-queueing-07][https://git.kernel.org/pub/scm/linux/kernel/git/toke/linux.git/log/?h=xdp-queueing-07]]

* Emacs end-tricks                                                 :noexport:

This section contains some emacs tricks, that e.g. remove the "Slide:" prefix
in the compiled version.

# Local Variables:
# org-re-reveal-title-slide: "<h1 class=\"title\">%t</h1>
# <h2 class=\"author\">Toke Høiland-Jørgensen<br/><span style=\"font-size: 75%%\">Principal Kernel Engineer,
# Red Hat</span></h2>
# <h3>Linux Plumbers Conference</br>September 2022</h3>"
# org-export-filter-headline-functions: ((lambda (contents backend info) (replace-regexp-in-string "Slide: ?" "" contents)))
# End:
